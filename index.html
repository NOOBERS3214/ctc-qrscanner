<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Continuous QR Scanner with Excel Export</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial; background:#0b0b0b; color:#fff; text-align:center; }
video { width:100%; max-width:420px; border:2px solid #0f0; margin-bottom:10px; }
table { width:100%; max-width:420px; margin:auto; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #333; padding:6px; font-size:14px; }
th { background:#111; }
select, button { padding:6px; margin:5px; font-size:16px; }
button { cursor:pointer; }

/* Big SCANNED overlay */
#scannedOverlay {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 80px;
  font-weight: bold;
  color: #0f0;
  text-shadow: 2px 2px 10px #000;
  display: none;
  pointer-events: none;
  z-index: 9999;
}
</style>
</head>

<body>

<h2>CTC Register Taker</h2>

<label>Select Year:</label><br>
<select id="yearSelect">
  <option value="Year 1">Year 1</option>
  <option value="Year 2">Year 2</option>
  <option value="Year 3">Year 3</option>
  <option value="Year 4">Year 4</option>
</select>

<br>
<button onclick="exportExcel()">Export to Excel</button>

<video id="video" autoplay></video>
<canvas id="canvas" hidden></canvas>

<p id="status">Initializing scanner…</p>

<div id="scannedOverlay">SCANNED ✓</div>

<table>
<thead>
<tr>
  <th>#</th>
  <th>QR Data</th>
  <th>Year</th>
  <th>Time</th>
</tr>
</thead>
<tbody id="log"></tbody>
</table>

<!-- QR Scanner -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<!-- Excel Export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const log = document.getElementById("log");
const status = document.getElementById("status");
const yearSelect = document.getElementById("yearSelect");
const overlay = document.getElementById("scannedOverlay");

let lastScan = "";
let scanLock = false;
let count = 0;

// Automatically start camera on page load
window.addEventListener('load', () => {
  startScanner();
});

function startScanner() {
  status.innerText = "Requesting camera…";

  navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: "environment",
      width: { ideal: 640 },
      height: { ideal: 480 }
    }
  })
  .then(stream => {
    video.srcObject = stream;
    status.innerText = "Scanning…";
    scanLoop(); // start throttled scan loop
  })
  .catch(err => status.innerText = "Camera error: " + err);
}

// Throttled scan (~8 times/sec)
function scanLoop() {
  if (video.readyState === video.HAVE_ENOUGH_DATA && !scanLock) {
    const scanWidth = 320;
    const scanHeight = 240;
    canvas.width = scanWidth;
    canvas.height = scanHeight;

    ctx.drawImage(video, 0, 0, scanWidth, scanHeight);
    const imageData = ctx.getImageData(0, 0, scanWidth, scanHeight);
    const code = jsQR(imageData.data, scanWidth, scanHeight);

    if (code && code.data !== lastScan) {
      lastScan = code.data;
      scanLock = true;
      count++;

      const selectedYear = yearSelect.value;

      const row = log.insertRow(-1);
      row.innerHTML = `
        <td>${count}</td>
        <td>${code.data}</td>
        <td>${selectedYear}</td>
        <td>${new Date().toLocaleTimeString()}</td>
      `;

      // Show big SCANNED overlay
      overlay.style.display = "block";

      status.innerText = "Scanned ✓";

      // Hide overlay after 1 second
      setTimeout(() => {
        scanLock = false;
        overlay.style.display = "none";
        status.innerText = "Scanning…";
      }, 1000);
    }
  }
  setTimeout(scanLoop, 120); // ~8 scans/sec
}

// Excel export
function exportExcel() {
  const rows = [["#", "QR Data", "Year", "Time"]];
  const tableRows = document.querySelectorAll("#log tr");

  tableRows.forEach(tr => {
    const cells = tr.querySelectorAll("td");
    rows.push([
      cells[0].innerText,
      cells[1].innerText,
      cells[2].innerText,
      cells[3].innerText
    ]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "Scans");

  XLSX.writeFile(wb, "qr_scans.xlsx");
}
</script>

</body>
</html>


